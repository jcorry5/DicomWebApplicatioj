function toggleComment(n){commentToggle=n}function shapes(n){shape=n}function penSize(n){penWidth=n;document.getElementById("pensize").innerHTML=penWidth}function colourChoice(n){colour=n}function labelFormat(n){label=n}var canvasx,canvasy,width,height,DbJson,TouchClientX,TouchClientY,db,objectStore,request,i,comment,object,canvas=document.getElementById("anno-canvas"),imageCanvas=document.getElementById("image-canvas"),context=imageCanvas.getContext("2d"),ctx=canvas.getContext("2d"),last_mousex=last_mousey=0,mousex=mousey=0,mousedown=!1,penWidth=2,colour="black",shape="rect",label="numberFirst",str="ABCDEFGHIJKLMNOPQRSTUVWXYZ",nextChar="A",char=0,num=0,JsonArrayOfShapes=[],arrayofundoneAnnotations=[],shapesUndone=!1,AnotationsSaved=!0,save=!1,numberofthingsundone=0,menu=document.getElementById("annotationList"),note=document.getElementById("notifications"),commentToggle="OFF";$(document).ready(function(){function i(){return str.charAt(char)}function n(){return nextChar=str.charAt(char),str.charAt(char+1)!==null?char++:char=0,nextChar}function t(){return num++,num}function c(n){canvasx=$(canvas).offset().left;canvasy=$(canvas).offset().top;last_mousex=parseInt(n.clientX-canvasx);last_mousey=parseInt(n.clientY-canvasy);mousedown=!0}function l(){shapesUndone&&(arrayofundoneAnnotations=[],shapesUndone=!1);commentToggle==="ON"&&(comment=prompt("comment:"));var n=document.createElement("li");label==="numberFirst"&&commentToggle==="ON"?(n.innerHTML=shape+" "+parseInt(num+1)+comment,menu.appendChild(n)):label==="letterFirst"&&commentToggle==="ON"&&(n.innerHTML=shape+" "+i()+" "+comment,menu.appendChild(n));mousedown=!1;context.beginPath();context.strokeStyle=colour;context.lineWidth=penWidth;context.font="12px Arial";width=mousex-last_mousex;height=mousey-last_mousey;u();AnotationsSaved=!1;ctx.clearRect(0,0,canvas.width,canvas.height);h()}function u(){switch(shape){case"rect":var r;r=mousey>last_mousey?mousey:last_mousey;o(context,width,height);context.lineWidth=2;label==="numberFirst"?(console.log(label),context.strokeText(t(),(mousex+last_mousex)/2,r+10)):label==="letterFirst"&&(console.log(label),context.strokeText(n(),(mousex+last_mousex)/2,r+10));break;case"line":f(context);context.lineWidth=2;label==="numberFirst"?context.strokeText(t(),(mousex+last_mousex)/2,(mousey+last_mousey)/2):label==="letterFirst"&&context.strokeText(n(),(mousex+last_mousex)/2,(mousey+last_mousey)/2);break;case"arrow":s(context);context.lineWidth=2;label==="numberFirst"?context.strokeText(t(),(mousex+last_mousex)/2,(mousey+last_mousey)/2):label==="letterFirst"&&context.strokeText(n(),(mousex+last_mousex)/2,(mousey+last_mousey)/2);break;case"quad":e(context);context.lineWidth=2;label==="numberFirst"?(num++,context.strokeText(num+n(),mousex,mousey),context.strokeText(num+n(),last_mousex,mousey),context.strokeText(num+n(),mousex,last_mousey),context.strokeText(num+n(),last_mousex,last_mousey)):label==="letterFirst"&&(char++,context.strokeText(i()+t(),mousex,mousey),context.strokeText(i()+t(),last_mousex,mousey),context.strokeText(i()+t(),mousex,last_mousey),context.strokeText(i()+t(),last_mousex,last_mousey))}}function a(n){if(mousex=parseInt(n.clientX-canvasx),mousey=parseInt(n.clientY-76),mousedown){ctx.clearRect(0,0,imageCanvas.width,imageCanvas.height);ctx.beginPath();ctx.strokeStyle=colour;ctx.lineWidth=penWidth;var t=mousex-last_mousex,i=mousey-last_mousey;switch(shape){case"rect":o(ctx,t,i);break;case"line":f(ctx);break;case"arrow":s(ctx);break;case"quad":e(ctx)}}}function f(n){n.moveTo(last_mousex,last_mousey);n.lineTo(mousex,mousey);n.stroke()}function e(n){n.moveTo(last_mousex,last_mousey+(mousey-last_mousey)/2);n.bezierCurveTo(last_mousex,last_mousey,mousex,last_mousey,mousex,last_mousey+(mousey-last_mousey)/2);n.bezierCurveTo(mousex,mousey,last_mousex,mousey,last_mousex,last_mousey+(mousey-last_mousey)/2);n.closePath();n.stroke();var t=(mousex-last_mousex)/2+last_mousex,i=(mousey-last_mousey)/2+last_mousey;n.beginPath();n.strokeStyle=colour;n.lineWidth=penWidth;n.moveTo(last_mousex,i);n.lineTo(mousex,i);n.stroke();n.beginPath();n.strokeStyle=colour;n.lineWidth=penWidth;n.moveTo(t,last_mousey);n.lineTo(t,mousey);n.stroke()}function o(n,t,i){n.rect(last_mousex,last_mousey,t,i);n.stroke()}function s(n){n.moveTo(last_mousex,last_mousey);var t=10,i=Math.atan2(mousey-last_mousey,mousex-last_mousex);n.lineTo(mousex,mousey);n.lineTo(mousex-t*Math.cos(i-Math.PI/6),mousey-t*Math.sin(i-Math.PI/6));n.moveTo(mousex,mousey);n.lineTo(mousex-t*Math.cos(i+Math.PI/6),mousey-t*Math.sin(i+Math.PI/6));n.stroke()}function r(n){context.beginPath();context.strokeStyle=JsonArrayOfShapes[n].colour;context.lineWidth=JsonArrayOfShapes[n].pensize;shape=JsonArrayOfShapes[n].shape;mousex=JsonArrayOfShapes[n].X;mousey=JsonArrayOfShapes[n].Y;last_mousex=JsonArrayOfShapes[n].lastX;last_mousey=JsonArrayOfShapes[n].lastY;width=mousex-last_mousex;height=mousey-last_mousey;label=JsonArrayOfShapes[n].LabelFormat;u()}function v(){try{setTimeout(function(){console.log(JsonArrayOfShapes);for(var n=0;n<JsonArrayOfShapes.length;n++)r(n)},500)}catch(n){console.log(n)}}function h(){object={annotationNum:num,filename:document.getElementById("workingFile").innerHTML,shape:shape,pensize:penWidth,colour:colour,X:mousex,Y:mousey,lastX:last_mousex,lastY:last_mousey,LabelFormat:label,Comment:comment};JsonArrayOfShapes.push(object)}window.onbeforeunload=function(n){var t="All annotations may not have been saved. Are you sure you want to leave?";if(!AnotationsSaved)return n.returnValue=t,t};$("#erase").click(function(){var n=confirm("delete all unsaved annotations?");n===!0&&(num=0,char=0,JsonArrayOfShapes=[])});$(canvas).on("mousedown",function(n){c(n)});$(canvas).on("mouseup",function(n){l(n)});$(canvas).on("mousemove",function(n){a(n)});$("#redo").click(function(){if(shapesUndone)if(numberofthingsundone!==0){var n=arrayofundoneAnnotations.pop();JsonArrayOfShapes.push(n);r(JsonArrayOfShapes.length-1);numberofthingsundone--}else alert("redone everything");else alert("we can't find anything to redo, sorry")});$("#undo").click(function(){try{if(num>0){var n=JsonArrayOfShapes.pop();context.clearRect(0,0,canvas.width,canvas.height);char=0;num=0;setTimeout(function(){for(var n=0;n<JsonArrayOfShapes.length;n++)r(n)},500);arrayofundoneAnnotations.push(n);shapesUndone=!0;numberofthingsundone++}else alert("there is nothing to undo.")}catch(t){console.log(t)}});note.innerHTML+="<li>Application opened.<\/li>";window.indexedDB=window.indexedDB||window.webkitIndexedDb||window.OIndexedDB||window.msIndexedDB;IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||window.OIDBTransaction||window.msIDBTransaction;dbversion=5;request=indexedDB.open("ImageAnotations",dbversion);request.onsuccess=function(){if(note.innerHTML+="<li>Database created.<\/li>",console.log("success creating database"),db=request.result,db.setversion&&db.version!==dbversion){var n=db.setversion(dbversion);n.onsuccess=function(){createobjectstore(db)}}db.onerror=function(n){alert("database error: "+n.target.errorCode)}};request.onerror=function(){console.log("Error creating / accessing IndexedDB database");note.innerHTML+="<li>Error creating / accessing IndexedDB database.<\/li>"};request.onupgradeneeded=function(n){var t=n.target.result;t.onerror=function(){console.log("error loading database.");note.innerHTML+="<li>Error loading database.<\/li>"};objectStore=t.createObjectStore("Annotation",{keyPath:"FileID",autoIncrement:!0});objectStore.createIndex("filename","filename",{unique:!1});objectStore.createIndex("annotationNum","annotationNum",{unique:!1});objectStore.createIndex("shape","shape",{unique:!1});objectStore.createIndex("pensize","pensize",{unique:!1});objectStore.createIndex("colour","colour",{unique:!1});objectStore.createIndex("X","X",{unique:!1});objectStore.createIndex("Y","Y",{unique:!1});objectStore.createIndex("LastX","LastX",{unique:!1});objectStore.createIndex("LastY","LastY",{unique:!1});objectStore.createIndex("labelFormat","labelFormat",{unique:!1});objectStore.createIndex("Comment","Comment",{unique:!1});console.log("objectStore created");note.innerHTML+="<li>Ojectstore created.<\/li>"};$("#LoadLocal").click(function(){var t;num=0;char=0;JsonArrayOfShapes=[];var n=db.transaction("Annotation","readonly"),i=n.objectStore("Annotation"),r=i.index("annotationNum");n.onerror=function(){console.log("something went wrong loading data")};t=r.openCursor();t.onsuccess=function(n){var t=n.target.result,i;t&&(t.value.filename===document.getElementById("workingFile").innerHTML&&(annotationNum=t.value.annotationNum,shape=t.value.shape,penWidth=t.value.pensize,colour=String(t.value.colour),mousex=parseInt(t.value.X),mousey=parseInt(t.value.Y),last_mousex=parseInt(t.value.lastX),last_mousey=parseInt(t.value.lastY),comment=t.value.Comment,label=String(t.value.LabelFormat),h(),i=document.createElement("li"),i.innerHTML=t.value.Comment?t.value.annotationNum+") "+t.value.shape+" "+t.value.Comment:t.value.annotationNum+") "+t.value.shape,menu.appendChild(i)),t.continue())};console.log("finished");note.innerHTML+="<li>All available objects loaded.<\/li>";v()});$("#deleteall").click(function(){var t=document.getElementById("workingFile");console.log(t);var i=db.transaction(["Annotation"],"readwrite"),n=i.objectStore("Annotation"),r=n.index("filename"),u=r.openKeyCursor();u.onsuccess=function(t){var i=t.target.result,r;for(i&&(i.key===document.getElementById("workingFile").innerHTML&&(r=n.delete(i.primaryKey)),i.continue()),console.log("deleted"),note.innerHTML+="<li>Database cleared.<\/li>";menu.firstChild;)menu.removeChild(menu.firstChild)}});$("#saveLocal").click(function(){var t=db.transaction(["Annotation"],"readwrite"),n,r,i;for(t.onsuccess=function(){console.log("transaction sucessful")},t.onerror=function(){console.log("transaction error on saving shapes.")},n=0;n<JsonArrayOfShapes.length;n++)r=t.objectStore("Annotation"),i=r.add(JsonArrayOfShapes[n]),i.onsuccess=function(){AnotationsSaved=!0;console.log("array success fully saved to database");note.innerHTML+="<li>Annotations successfully saved.<\/li>"},i.onerror=function(){console.log("something went wrong")}});$("#saveServer").bind("click",function(){var n=JSON.stringify(JsonArrayOfShapes);console.log(n);$.ajax({url:"/Annotations/PassData",type:"post",data:n,dataType:"json",contentType:"application/json",traditional:!0,error:function(n){alert(n.statusText)},success:function(){note.innerHTML+="<li>Annotations successfully saved to server.<\/li>"}})})});