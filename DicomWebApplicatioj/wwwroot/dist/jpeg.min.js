var ColorSpace={Unkown:0,Grayscale:1,AdobeRGB:2,RGB:3,CYMK:4},JpegImage=function(){"use strict";function l(){}function a(n,t){for(var s=0,r=[],u,o,e=16,i,f;e>0&&!n[e-1];)e--;for(r.push({children:[],index:0}),i=r[0],u=0;u<e;u++){for(o=0;o<n[u];o++){for(i=r.pop(),i.children[i.index]=t[s];i.index>0;)i=r.pop();for(i.index++,r.push(i);r.length<=u;)r.push(f={children:[],index:0}),i.children[i.index]=f.children,i=f;s++}u+1<e&&(r.push(f={children:[],index:0}),i.children[i.index]=f.children,i=f)}return r[0].children}function r(n,t,i){return 64*((n.blocksPerLine+1)*t+i)}function v(n,t,u,f,e,o,s,h,c){function y(){if(d>0)return d--,k>>d&1;if(k=n[t++],k==255){var i=n[t++];if(i)throw"unexpected marker: "+(k<<8|i).toString(16);}return d=7,k>>>7}function g(n){for(var t=n,i;(i=y())!==null;){if(t=t[i],typeof t=="number")return t;if(typeof t!="object")throw"invalid huffman sequence";}return null}function et(n){for(var t=0,i;n>0;){if(i=y(),i===null)return;t=t<<1|i;n--}return t}function nt(n){var t=et(n);return t>=1<<n-1?t:t+(-1<<n)+1}function yt(n,t){var u=g(n.huffmanTableDC),h=u===0?0:nt(u),r,s;for(n.blockData[t]=n.pred+=h,r=1;r<64;){var f=g(n.huffmanTableAC),e=f&15,o=f>>4;if(e===0){if(o<15)break;r+=16;continue}r+=o;s=i[r];n.blockData[t+s]=nt(e);r++}}function pt(n,t){var i=g(n.huffmanTableDC),r=i===0?0:nt(i)<<c;n.blockData[t]=n.pred+=r}function wt(n,t){n.blockData[t]|=y()<<c}function bt(n,t){var r,f,l;if(v>0){v--;return}for(r=o,f=s;r<=f;){var e=g(n.huffmanTableAC),h=e&15,u=e>>4;if(h===0){if(u<15){v=et(u)+(1<<u)-1;break}r+=16;continue}r+=u;l=i[r];n.blockData[t+l]=nt(h)*(1<<c);r++}}function kt(n,t){for(var e=o,a=s,r=0,u,h,f;e<=a;){u=i[e];switch(l){case 0:if(h=g(n.huffmanTableAC),f=h&15,r=h>>4,f===0)r<15?(v=et(r)+(1<<r),l=4):(r=16,l=1);else{if(f!==1)throw"invalid ACn encoding";ht=nt(f);l=r?2:3}continue;case 1:case 2:n.blockData[t+u]?n.blockData[t+u]+=y()<<c:(r--,r===0&&(l=l==2?3:0));break;case 3:n.blockData[t+u]?n.blockData[t+u]+=y()<<c:(n.blockData[t+u]=ht<<c,l=0);break;case 4:n.blockData[t+u]&&(n.blockData[t+u]+=y()<<c)}e++}l===4&&(v--,v===0&&(l=0))}function dt(n,t,i,u,f){var e=i/ft|0,o=i%ft,s=e*n.v+u,h=o*n.h+f,c=r(n,s,h);t(n,c)}function gt(n,t,i){var u=i/n.blocksPerLine|0,f=i%n.blocksPerLine,e=r(n,u,f);t(n,e)}var ni=u.precision,ti=u.samplesPerLine,ii=u.scanLines,ft=u.mcusPerLine,at=u.progressive,ri=u.maxH,ui=u.maxV,vt=t,k=0,d=0,v=0,l=0,ht,tt=f.length,p,a,it,rt,w,ot,b,ut,st,ct,lt;for(ot=at?o===0?h===0?pt:wt:h===0?bt:kt:yt,b=0,st=tt==1?f[0].blocksPerLine*f[0].blocksPerColumn:ft*u.mcusPerColumn,e||(e=st);b<st;){for(a=0;a<tt;a++)f[a].pred=0;if(v=0,tt==1)for(p=f[0],w=0;w<e;w++)gt(p,ot,b),b++;else for(w=0;w<e;w++){for(a=0;a<tt;a++)for(p=f[a],ct=p.h,lt=p.v,it=0;it<lt;it++)for(rt=0;rt<ct;rt++)dt(p,ot,b,it,rt);b++}if(d=0,ut=n[t]<<8|n[t+1],ut<=65280)throw"marker was not found";if(ut>=65488&&ut<=65495)t+=2;else break}return t-vt}function y(t,i,r){for(var ut=t.quantizationTable,p,w,b,k,d,g,nt,tt,l,a,v,rt,it,y=0;y<64;y++)r[y]=t.blockData[i+y]*ut[y];for(y=0;y<8;++y){if(a=8*y,r[1+a]===0&&r[2+a]===0&&r[3+a]===0&&r[4+a]===0&&r[5+a]===0&&r[6+a]===0&&r[7+a]===0){l=n*r[0+a]+512>>10;r[0+a]=l;r[1+a]=l;r[2+a]=l;r[3+a]=l;r[4+a]=l;r[5+a]=l;r[6+a]=l;r[7+a]=l;continue}p=n*r[0+a]+128>>8;w=n*r[4+a]+128>>8;b=r[2+a];k=r[6+a];d=c*(r[1+a]-r[7+a])+128>>8;tt=c*(r[1+a]+r[7+a])+128>>8;g=r[3+a]<<4;nt=r[5+a]<<4;l=p-w+1>>1;p=p+w+1>>1;w=l;l=b*h+k*s+128>>8;b=b*s-k*h+128>>8;k=l;l=d-nt+1>>1;d=d+nt+1>>1;nt=l;l=tt+g+1>>1;g=tt-g+1>>1;tt=l;l=p-k+1>>1;p=p+k+1>>1;k=l;l=w-b+1>>1;w=w+b+1>>1;b=l;l=d*o+tt*e+2048>>12;d=d*e-tt*o+2048>>12;tt=l;l=g*f+nt*u+2048>>12;g=g*u-nt*f+2048>>12;nt=l;r[0+a]=p+tt;r[7+a]=p-tt;r[1+a]=w+nt;r[6+a]=w-nt;r[2+a]=b+g;r[5+a]=b-g;r[3+a]=k+d;r[4+a]=k-d}for(y=0;y<8;++y){if(v=y,r[8+v]===0&&r[16+v]===0&&r[24+v]===0&&r[32+v]===0&&r[40+v]===0&&r[48+v]===0&&r[56+v]===0){l=n*r[y+0]+8192>>14;r[0+v]=l;r[8+v]=l;r[16+v]=l;r[24+v]=l;r[32+v]=l;r[40+v]=l;r[48+v]=l;r[56+v]=l;continue}p=n*r[0+v]+2048>>12;w=n*r[32+v]+2048>>12;b=r[16+v];k=r[48+v];d=c*(r[8+v]-r[56+v])+2048>>12;tt=c*(r[8+v]+r[56+v])+2048>>12;g=r[24+v];nt=r[40+v];l=p-w+1>>1;p=p+w+1>>1;w=l;l=b*h+k*s+2048>>12;b=b*s-k*h+2048>>12;k=l;l=d-nt+1>>1;d=d+nt+1>>1;nt=l;l=tt+g+1>>1;g=tt-g+1>>1;tt=l;l=p-k+1>>1;p=p+k+1>>1;k=l;l=w-b+1>>1;w=w+b+1>>1;b=l;l=d*o+tt*e+2048>>12;d=d*e-tt*o+2048>>12;tt=l;l=g*f+nt*u+2048>>12;g=g*u-nt*f+2048>>12;nt=l;r[0+v]=p+tt;r[56+v]=p-tt;r[8+v]=w+nt;r[48+v]=w-nt;r[16+v]=b+g;r[40+v]=b-g;r[24+v]=k+d;r[32+v]=k-d}for(y=0;y<64;++y)rt=i+y,it=r[y],it=it<=-2056/t.bitConversion?0:it>=2024/t.bitConversion?255/t.bitConversion:it+2056/t.bitConversion>>4,t.blockData[rt]=it}function p(n,t){for(var i,e,f=t.blocksPerLine,o=t.blocksPerColumn,h=f<<3,s=new Int32Array(64),u=0;u<o;u++)for(i=0;i<f;i++)e=r(t,u,i),y(t,e,s);return t.blockData}function t(n){return n<=0?0:n>=255?255:n|0}var i=new Int32Array([0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63]),u=4017,f=799,e=3406,o=2276,s=1567,h=3784,n=5793,c=2896;return l.prototype={load:function(n){var u=function(n){this.parse(n);this.onload&&this.onload()}.bind(this),i,t;if(n.indexOf("data:")>-1){var f=n.indexOf("base64,")+7,r=atob(n.substring(f)),e=new Uint8Array(r.length);for(i=r.length-1;i>=0;i--)e[i]=r.charCodeAt(i);u(r)}else t=new XMLHttpRequest,t.open("GET",n,!0),t.responseType="arraybuffer",t.onload=function(){var n=new Uint8Array(t.response);u(n)}.bind(this),t.send(null)},parse:function(n){function o(){var i=n[t]<<8|n[t+1];return t+=2,i}function gt(){var r=o(),i=n.subarray(t,t+r-2);return t+=i.length,i}function ni(n){for(var i=Math.ceil(n.samplesPerLine/8/n.maxH),r=Math.ceil(n.scanLines/8/n.maxV),t=0;t<n.components.length;t++){f=n.components[t];var u=Math.ceil(Math.ceil(n.samplesPerLine/8)*f.h/n.maxH),e=Math.ceil(Math.ceil(n.scanLines/8)*f.v/n.maxV),o=i*f.h,s=r*f.v,h=64*s*(o+1);f.blockData=new Int16Array(h);f.blocksPerLine=u;f.blocksPerColumn=e}n.mcusPerLine=i;n.mcusPerColumn=r}var t=0,ei=n.length,rt=null,ut=null,u,ft,k=[],et=[],ot=[],h=o(),e,st,r,ht,ct,c,l,lt,at,y,w,nt,yt,tt,kt,it,s,f;if(h!=65496)throw"SOI not found";for(h=o();h!=65497;){switch(h){case 65504:case 65505:case 65506:case 65507:case 65508:case 65509:case 65510:case 65511:case 65512:case 65513:case 65514:case 65515:case 65516:case 65517:case 65518:case 65519:case 65534:r=gt();h===65504&&r[0]===74&&r[1]===70&&r[2]===73&&r[3]===70&&r[4]===0&&(rt={version:{major:r[5],minor:r[6]},densityUnits:r[7],xDensity:r[8]<<8|r[9],yDensity:r[10]<<8|r[11],thumbWidth:r[12],thumbHeight:r[13],thumbData:r.subarray(14,14+3*r[12]*r[13])});h===65518&&r[0]===65&&r[1]===100&&r[2]===111&&r[3]===98&&r[4]===101&&r[5]===0&&(ut={version:r[6],flags0:r[7]<<8|r[8],flags1:r[9]<<8|r[10],transformCode:r[11]});break;case 65499:for(ht=o(),ct=ht+t-2;t<ct;){if(c=n[t++],l=new Int32Array(64),c>>4==0)for(e=0;e<64;e++)lt=i[e],l[lt]=n[t++];else if(c>>4==1)for(e=0;e<64;e++)at=i[e],l[at]=o();else throw"DQT: invalid table spec";k[c&15]=l}break;case 65472:case 65473:case 65474:if(u)throw"Only single frame JPEGs supported";o();u={};u.extended=h===65473;u.progressive=h===65474;u.precision=n[t++];u.scanLines=o();u.samplesPerLine=o();u.components=[];u.componentIds={};var ti=n[t++],vt,d=0,g=0;for(s=0;s<ti;s++)vt=n[t],y=n[t+1]>>4,w=n[t+1]&15,d<y&&(d=y),g<w&&(g=w),nt=n[t+2],st=u.components.push({h:y,v:w,quantizationTable:k[nt],quantizationTableId:nt,bitConversion:255/((1<<u.precision)-1)}),u.componentIds[vt]=st-1,t+=3;u.maxH=d;u.maxV=g;ni(u);break;case 65476:for(yt=o(),s=2;s<yt;){var pt=n[t++],wt=new Uint8Array(16),b=0;for(e=0;e<16;e++,t++)b+=wt[e]=n[t];for(tt=new Uint8Array(b),e=0;e<b;e++,t++)tt[e]=n[t];s+=17+b;(pt>>4==0?ot:et)[pt&15]=a(wt,tt)}break;case 65501:o();ft=o();break;case 65498:var oi=o(),ii=n[t++],bt=[],f;for(s=0;s<ii;s++)kt=u.componentIds[n[t++]],f=u.components[kt],it=n[t++],f.huffmanTableDC=ot[it>>4],f.huffmanTableAC=et[it&15],bt.push(f);var ri=n[t++],ui=n[t++],dt=n[t++],fi=v(n,t,u,bt,ft,ri,ui,dt>>4,dt&15);t+=fi;break;default:if(n[t-3]==255&&n[t-2]>=192&&n[t-2]<=254){t-=3;break}throw"unknown JPEG marker "+h.toString(16);}h=o()}this.width=u.samplesPerLine;this.height=u.scanLines;this.jfif=rt;this.adobe=ut;this.components=[];switch(u.components.length){case 1:this.colorspace=ColorSpace.Grayscale;break;case 3:this.colorspace=this.adobe?ColorSpace.AdobeRGB:ColorSpace.RGB;break;case 4:this.colorspace=ColorSpace.CYMK;break;default:this.colorspace=ColorSpace.Unknown}for(s=0;s<u.components.length;s++)f=u.components[s],f.quantizationTable||f.quantizationTableId===null||(f.quantizationTable=k[f.quantizationTableId]),this.components.push({output:p(u,f),scaleX:f.h/u.maxH,scaleY:f.v/u.maxV,blocksPerLine:f.blocksPerLine,blocksPerColumn:f.blocksPerColumn,bitConversion:f.bitConversion})},getData16:function(n,t){var f,g,e,d,nt,tt,it;if(this.components.length!==1)throw"Unsupported color mode";for(var rt=this.width/n,ut=this.height/t,i,v,y,o,s,h=0,a=this.components.length,ft=n*t*a,p=new Uint16Array(ft),w=new Uint16Array((this.components[0].blocksPerLine<<3)*this.components[0].blocksPerColumn*8),u=0;u<a;u++){i=this.components[u];var b=i.blocksPerLine,et=i.blocksPerColumn,k=b<<3,c,l,d=0;for(f=0;f<et;f++)for(g=f<<3,e=0;e<b;e++){var ot=r(i,f,e),h=0,st=e<<3;for(c=0;c<8;c++)for(d=(g+c)*k,l=0;l<8;l++)w[d+st+l]=i.output[ot+h++]}for(v=i.scaleX*rt,y=i.scaleY*ut,h=u,s=0;s<t;s++)for(o=0;o<n;o++)tt=0|s*y,nt=0|o*v,it=tt*k+nt,p[h]=w[it],h+=a}return p},getData:function(n,i){for(var yt=this.width/n,pt=this.height/i,o,g,nt,y,p,w=0,e,h,c,tt,it,rt,ut,ft,s,l=this.components.length,d=n*i*l,f=new Uint8Array(d),et=new Uint8Array((this.components[0].blocksPerLine<<3)*this.components[0].blocksPerColumn*8),a,ct,v,ht,lt,at,vt,u=0;u<l;u++){o=this.components[u];var ot=o.blocksPerLine,wt=o.blocksPerColumn,st=ot<<3,b,k,ht=0;for(a=0;a<wt;a++)for(ct=a<<3,v=0;v<ot;v++){var bt=r(o,a,v),w=0,kt=v<<3;for(b=0;b<8;b++)for(ht=(ct+b)*st,k=0;k<8;k++)et[ht+kt+k]=o.output[bt+w++]*o.bitConversion}for(g=o.scaleX*yt,nt=o.scaleY*pt,w=u,p=0;p<i;p++)for(y=0;y<n;y++)at=0|p*nt,lt=0|y*g,vt=at*st+lt,f[w]=et[vt],w+=l}switch(l){case 1:case 2:break;case 3:if(s=!0,this.adobe&&this.adobe.transformCode?s=!0:typeof this.colorTransform!="undefined"&&(s=!!this.colorTransform),s)for(u=0;u<d;u+=l)e=f[u],h=f[u+1],c=f[u+2],rt=t(e-179.456+1.402*c),ut=t(e+135.459-.344*h-.714*c),ft=t(e-226.816+1.772*h),f[u]=rt,f[u+1]=ut,f[u+2]=ft;break;case 4:if(!this.adobe)throw"Unsupported color mode (4 components)";if(s=!1,this.adobe&&this.adobe.transformCode?s=!0:typeof this.colorTransform!="undefined"&&(s=!!this.colorTransform),s)for(u=0;u<d;u+=l)e=f[u],h=f[u+1],c=f[u+2],tt=t(434.456-e-1.402*c),it=t(119.541-e+.344*h+.714*c),e=t(481.816-e-1.772*h),f[u]=tt,f[u+1]=it,f[u+2]=e;break;default:throw"Unsupported color mode";}return f}},l}();